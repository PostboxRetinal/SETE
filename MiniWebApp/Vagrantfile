# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile para CloudNova - Proyecto Servicios Telemáticos
# Despliegue local con Docker, Prometheus, Grafana y monitoreo completo

Vagrant.configure("2") do |config|
  
  # ===========================================
  # SERVIDOR WEB CON DOCKER Y MONITOREO
  # ===========================================
  config.vm.define :cloudnova_local do |server|
    # Imagen base de Ubuntu 22.04 LTS custom actualizada
    server.vm.box = "postboxretinal/ubuntu-2204-updated"
    server.vm.hostname = "cloudnova"
    
    # Configuración de red
    server.vm.network "private_network", ip: "192.168.60.10"
    
    # Configuración de puertos
    server.vm.network "forwarded_port", guest: 80, host: 8080, protocol: "tcp" # HTTP
    server.vm.network "forwarded_port", guest: 443, host: 8443, protocol: "tcp" # HTTPS
    
    # Recursos de la VM
    server.vm.provider "virtualbox" do |vb|
      vb.name = "cloudnova-local"
      vb.memory = "4096"
      vb.cpus = 2
      vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
      vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
      vb.customize ["modifyvm", :id, "--vram", "16"]  # Reducir VRAM a 16MB
    end
    
    # Sincronizar carpeta del proyecto
    server.vm.synced_folder ".", "/home/vagrant/MiniWebApp", 
      owner: "vagrant", 
      group: "vagrant"
    
    # Aprovisionamiento: Instalación de Docker y Docker Compose (método oficial sugerido en https://docs.docker.com/engine/install/ubuntu/)
    server.vm.provision "shell", name: "install-docker", inline: <<-SHELL
      echo "==========================================="
      echo "Instalando docker..."
      echo "==========================================="

      # Instalar docker usando get-docker.sh (script oficial)
      curl -fsSL https://get.docker.com -o get-docker.sh
      sh get-docker.sh

      # Actualizar sistema
      apt update
      apt full-upgrade -y
      
      # Instalar dependencias
      apt install -y apt-transport-https
      
      # Agregar usuario vagrant al grupo docker
      usermod -aG docker vagrant
      echo "==========================================="
      echo "Docker instalado correctamente"
      echo "==========================================="
    SHELL

    # Aprovisionamiento: Desplegar aplicación con Docker Compose
    server.vm.provision "shell", name: "deploy-app", privileged: false, inline: <<-SHELL
      echo "==========================================="
      echo "Desplegando aplicación con docker compose..."
      echo "==========================================="
      
      cd /home/vagrant/MiniWebApp
      
      # Construir y levantar contenedores (con newgrp para activar permisos docker)
      sg docker -c "docker compose up -d --build"
      
      echo "==========================================="
      echo "Esperando a que los servicios estén listos..."
      echo "==========================================="
      sleep 30
      
      # Verificar estado de los contenedores
      sg docker -c "docker compose ps"
      
      echo "==========================================="
      echo "Desplegado 10 de 10 :)"
      echo "==========================================="
      echo ""
      echo "Accede a los servicios locales mediante HTTPS:"
      echo "  - webApp:        https://192.168.60.10"
      echo "  - Prometheus:    https://192.168.60.10/prometheus"
      echo "  - Grafana:       https://192.168.60.10/grafana"
      echo "  - Node Exporter: https://192.168.60.10/node-exporter"
      echo ""
      echo "Credenciales Grafana: admin / cloudnova*"
      echo "==========================================="
    SHELL
    
  end
  
end
